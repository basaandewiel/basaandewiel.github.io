# Home Assistant OS in Incus-VM on RPI5

- Home Assistant OS in Linux container (Incus/LXD) on RPI5 with reverse proxy (Nginx) in separate container
- Goal
  - I wanted to have Home Assistant OS running, but didn't want to dedicate a full Raspberry Pi for this. So I searched whether is was possible to have HA running in a Virtual Machine on my main Raspberry PI.
- used sources
  - <https://discussion.scottibyte.com/t/home-assistant-os-in-incus-101/648>
- Environment
  - Raspberry PI 5 with 4 GB RAM
  - Running Arch Linux
  - incus (linux container installed) with 4 containers running amongst them a Nginx reverse proxy
- WORKING machanism
  - 

<p>
      In order to run a Virtual Machine, an <span style="font-weight: bold;">emulator (qemu</span>) and <span style="font-weight: bold;">Virtualizing extensions (KVM </span>aka libvirt) are required.
    </p>

  - incus uses qemu for VM's
  - incus generates qemu config file from 1) incus profile attached to incus image
    and 2) from 'incus config edit <vmname>
    - for example for our test-vm
    - /run/incus/test-vm/qemu.conf
      - so do not edit this file; is generated on startup of incus vm
      - contains
        - # GPU
        - [device "qemu_gpu"]
        - driver = "virtio-gpu-pci"
          - #this is the problem
          - #this device is NOT in the output of: qemu-system-aarch64 -device help|grep -i virtio-gpu)
        - bus = "qemu_pcie3"
        - addr = "00.0"
- installation
  - commands on RPI5
    - wget https://github.com/home-assistant/operating-system/releases/download/16.3/haos_generic-aarch64-16.3.qcow2.xz
      - NB AARCH64 version
    - unxz haos_generic-aarch64-16.3.qcow2.xz
    - incus-migrate
      - Answer questions as follows:
        - local incus server: yes
        - 2: Virtual Machine
        - name of new instance: HA-OS
        - qcow2 file: ./haos_ova-16.3.qcow2
        - UEFI booting: yes
        - Secure boot: no
      - 1 begin the migration
      - NB: in contract to the instructions in the above mentioned source, on only de 'default' profile is used for this instance, not the 'bridged profile'
    - 

<p>
      incus config device override HA-OS root size=50GiB
    </p>

    - incus config set HA-OS limits.memory 2GiB
      - more RAM makes my RPI5 too busy/slow
    - 

<p>
      incus start HA-OS
    </p>

  - Of course starting HA-OS was not working the first time; I got error "Virtual machine not supported"
    - test whether a simple VM is working
      - :heavy_multiplication_x: incus launch images:debian/12 test-vm --vm -c security.secureboot=false
      - this gave the same error
  - ERROR virtual machine not supported
    - incus info | grep -i virtualization
      - should show "virtual machines: qemu
      - but this is NOT SHOWN
      - sudo incus admin shutdown
      - sudo systemctl restart incus
    - this is maybe not necessary
      - 

<span style="font-style: italic;">edk2-ovmf</span> and <span style="font-style: italic;">seabios</span>  are of architecture <span style="font-style: italic;">any</span>, you can download the packages from the Arch x86_64 repo and install them using pacma

      - 

<p>
      so copy edk2-ovmf-202508-1-any.pkg.tar.zst from <span style="font-weight: bold;">laptop</span>  /var/cache/pacman/pkg/ to RPI
    </p>

        - RPI: sudo pacman -U edk2-ovmf-202508-1-any.pkg.tar.zst
    - journalctl -u incus -n50
      - Unable to run feature checks during QEMU initialization: Unable to locate a UEFI firmware"
      - cause
        - 

Incus expects the <code dir="ltr" class="o8j0Mc" jscontroller="PR9Qj" jsuid="xBJPjc_p" data-complete="true" data-sae="">edk2-aarch64</code> firmware in a standard location like <code dir="ltr" class="o8j0Mc" jscontroller="PR9Qj" jsuid="xBJPjc_q" data-complete="true" data-sae="">/usr/share/qemu</code>. On Arch ARM, it is often stored in <code dir="ltr" class="o8j0Mc" jscontroller="PR9Qj" jsuid="xBJPjc_r" data-complete="true" data-sae="">/usr/share/edk2/aarch64/</code>. To fix this, you must explicitly point Incus to the correct directory by setting an environment variable in the service file.

    - package edk2-aarch64 is on the arch website flagged out-of-date
      - can download from mirror
        - <https://archlinux.org/packages/extra/any/edk2-aarch64/>
      - NB: not sure if this is necessary, or that installing of virt-firmware is sufficient
      - pacman -U <file>
      - now files are present at /usr/share/edk2/aarch64/
    - pacman -Ss edk2
      - search edk2 packages
      - gives: extra/virt-firmware 25.12-1
        - Collection of tools for edk2 firmware images
    - pacman -S virt-firmware
    - sudo systemctl edit incus.service
      - add
        - Environment=INCUS_EDK2_PATH=/usr/share/edk2/aarch64/
        - in the upper part (override part) of the file
        - this dir contains .fd files
    - systemctl restart incus
  - Now following error: virtio-gpu-pci is not a valid device model name
    - incus launch images:debian/12 test-vm --vm -c security.secureboot=false
      - gives error
      - incus info --show-log test-vm
        - 

'virtio-gpu-pci' is not a valid device model name

      - sudo pacman -S qemu-hw-display-virtio-gpu qemu-hw-display-virtio-vga virglrenderer
      - incus admin shutdown
      - systemctl restart incus
      - still same error; so disable graphics
        - incus config device add test-vm console none
    - journalctl -u incus -n 50
      - level=warning msg="Skipped moving GPT alternative header to end of disk as sgdisk command not found" dev=/var/lib/incus/storage-pools/default/virtual-machines/test-vm/root.img driver=dir pool=default
      - sudo pacman -S gptfdisk
      - pacman -S cdrtools
    - incus launch images:debian/12 test-vm --vm -c security.secureboot=false
      - still error of virtio-gpu-pci
      - list device qemu supports:
        - qemu-system-aarch64 -device help|grep -i virtio-gpu
        - gives: "virtio-gpu-device", bus virtio-bus
          - 

<p>
      so NOT virtio-gpu-<span style="font-weight: bold;">pci</span>
    </p>

        - so Incus must be configured to use a different devices
    - incus profile set default raw.qemu -- "-device virtio-gpu-device"
      - this command inserts
        - config:
            raw.qemu: -device virtio-gpu-device
      - can be checked via
        - incus profile edit default
    - :heavy_check_mark: pacman -S qemu-hw-display-virtio-gpu-pci
      - NB: this one did the trick I think
    - :heavy_check_mark: 

<p>
      incus launch images:debian/12 test-vm --vm -c security.secureboot=false #<span style="font-weight: bold;">now succesfull</span>
    </p>

    - Lets now try to start HA-OS
      - :heavy_check_mark: incus start HA-OS
        - gets IP after 20 seconds (incus list)
      - incus list #note the IP-address of the HA-OS container
      - I can access HA from the RPI5 via links browser
        - links <IP>:8123 (on RPI5) - works
    - cannot access HA-OS in browser from laptop
    - :heavy_check_mark: incus console HA-OS --show-log
      - shows log of the VM
  - 
- Now HA-OS is working, we have to make it accessible from the internet so we can configure it further. But to be able to configure HA-OS I have to login via a browser and my RPI5 is headless.
- Make HA-OS accessible via internet
  - Method: install graphical browser on RPI5, and display the GUI on laptop running Linux with Wayland (not X); I use a browser light on memory, to prevent memory exhaustion on RPI4
  - RPI5: pacman -S falkon
  - RPI5: pacman -S waypipe
  - Laptop: pacman -S waypipe
  - Now start falkon on RPI5, from laptop with display on laptop
  - Laptop: waypipe --no-gpu ssh baswi@192.168.1.15 falkon
    - the "-no-gpu:  switch is necessary
  - in falkon go to <IP of HA-OS VM)>:8123
<!-- freeplane2md: Converted from /home/baswi/Prive_sync/kanweg.mm at 2025-12-23T13:11:02+01:00 -->
